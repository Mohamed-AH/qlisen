<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø§ÙØ¸ - Ù…ØªØ§Ø¨Ø¹ Ø§Ù„ØªÙ„Ø§ÙˆØ© | Hafiz - Recitation Tracker</title>
    <!-- Eruda Mobile Console for Debugging -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Amiri', 'Traditional Arabic', 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a3a2a 0%, #1a5a3a 50%, #0a3a2a 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        h1 {
            color: #d4af37;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1em;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(212, 175, 55, 0.1);
        }

        .position-indicator {
            background: linear-gradient(135deg, #d4af37 0%, #f4cf57 100%);
            color: #0a3a2a;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .position-indicator h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .position-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .position-detail {
            background: rgba(10, 58, 42, 0.1);
            padding: 10px;
            border-radius: 10px;
        }

        .position-detail label {
            font-size: 0.9em;
            opacity: 0.8;
            display: block;
            margin-bottom: 5px;
        }

        .position-detail value {
            font-size: 1.3em;
            font-weight: bold;
            display: block;
        }

        .controls {
            text-align: center;
            margin: 30px 0;
        }

        button {
            background: linear-gradient(135deg, #d4af37 0%, #f4cf57 100%);
            color: #0a3a2a;
            border: none;
            padding: 18px 50px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 10px;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.6);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.listening {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .status.idle {
            background: rgba(149, 165, 166, 0.2);
            color: #666;
        }

        .status.listening {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .status.detecting {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        .status.success {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
        }

        .verse-display {
            background: #fff9e6;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            border-right: 5px solid #d4af37;
            min-height: 150px;
        }

        .verse-display h3 {
            color: #0a3a2a;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .arabic-text {
            font-size: 2em;
            line-height: 2.2;
            color: #333;
            font-family: 'Traditional Arabic', 'Amiri', sans-serif;
            text-align: justify;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #0a3a2a 0%, #1a5a3a 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-card label {
            font-size: 0.9em;
            opacity: 0.8;
            display: block;
            margin-bottom: 10px;
        }

        .stat-card value {
            font-size: 2em;
            font-weight: bold;
            color: #d4af37;
            display: block;
        }

        .transcript-box {
            background: rgba(10, 58, 42, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid rgba(10, 58, 42, 0.1);
        }

        .transcript-box h4 {
            color: #0a3a2a;
            margin-bottom: 10px;
        }

        .transcript-text {
            font-size: 1.2em;
            line-height: 1.8;
            color: #555;
            direction: rtl;
            min-height: 50px;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            color: #c0392b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
        }

        .session-info {
            background: rgba(212, 175, 55, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-right: 4px solid #d4af37;
        }

        .session-info p {
            margin: 5px 0;
            color: #0a3a2a;
        }

        .confidence-bar {
            background: rgba(0, 0, 0, 0.1);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
            transition: width 0.3s;
            border-radius: 5px;
        }

        .hidden {
            display: none;
        }

        footer {
            text-align: center;
            padding: 30px 20px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .arabic-text {
                font-size: 1.5em;
            }

            button {
                padding: 15px 35px;
                font-size: 18px;
            }
        }

        /* Analysis Report Styles */
        .report-section {
            margin-bottom: 30px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 20px;
            background: rgba(10, 58, 42, 0.05);
            border-radius: 15px;
            border: 2px solid rgba(212, 175, 55, 0.2);
        }

        .summary-label {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 10px;
        }

        .summary-value {
            font-size: 2em;
            font-weight: bold;
            color: #0a3a2a;
            margin-bottom: 5px;
        }

        .summary-value.excellent {
            color: #27ae60;
        }

        .summary-value.good {
            color: #f39c12;
        }

        .summary-value.needs-work {
            color: #e74c3c;
        }

        .summary-sublabel {
            font-size: 0.85em;
            color: #999;
        }

        .verse-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            border-left: 5px solid #ccc;
            background: #f8f9fa;
        }

        .verse-item.verse-perfect {
            border-left-color: #27ae60;
            background: rgba(39, 174, 96, 0.05);
        }

        .verse-item.verse-good {
            border-left-color: #3498db;
            background: rgba(52, 152, 219, 0.05);
        }

        .verse-item.verse-partial {
            border-left-color: #f39c12;
            background: rgba(243, 156, 18, 0.05);
        }

        .verse-item.verse-skipped {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }

        .verse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .verse-number {
            color: #0a3a2a;
        }

        .verse-status {
            font-size: 0.9em;
        }

        .verse-text {
            font-size: 1.4em;
            line-height: 2;
            color: #0a3a2a;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            font-family: 'Traditional Arabic', 'Amiri', serif;
        }

        .verse-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }

        .mistake-item {
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(231, 76, 60, 0.05);
            border-radius: 12px;
            border-right: 5px solid #e74c3c;
        }

        .mistake-title {
            font-weight: 600;
            color: #e74c3c;
            margin-bottom: 8px;
        }

        .mistake-words {
            font-size: 1.1em;
            color: #0a3a2a;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .mistake-suggestion {
            font-size: 0.95em;
            color: #666;
            margin-top: 8px;
        }

        .recommendations-list {
            list-style: none;
            padding: 0;
        }

        .recommendations-list li {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(39, 174, 96, 0.05);
            border-radius: 10px;
            border-right: 4px solid #27ae60;
        }

        .recommendations-list li:before {
            content: "ğŸ’¡ ";
            margin-left: 10px;
        }

        .encouragement {
            text-align: center;
            font-size: 1.3em;
            font-weight: 600;
            padding: 25px;
            margin-top: 30px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.2));
            border-radius: 15px;
            color: #0a3a2a;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ•Œ Ø­Ø§ÙØ¸ - Ù…ØªØ§Ø¨Ø¹ Ø§Ù„ØªÙ„Ø§ÙˆØ©</h1>
            <p class="subtitle">Hafiz - Full Quran Recitation Tracker</p>
        </header>

        <div class="card" id="config-card" style="display: none;">
            <h2 style="color: #0a3a2a; margin-bottom: 20px; text-align: center;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h2>
            <p style="text-align: center; margin-bottom: 15px; color: #666;">
                Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø¯Ù… (ngrok Ø£Ùˆ localhost):
            </p>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <input type="text" id="api-url-input"
                    placeholder="https://your-ngrok-url.ngrok.io"
                    style="flex: 1; padding: 12px; border: 2px solid #d4af37; border-radius: 8px; font-size: 16px; direction: ltr; text-align: left;"
                    value="">
                <button onclick="updateApiUrl()" style="padding: 12px 24px; white-space: nowrap;">
                    Ø­ÙØ¸
                </button>
            </div>
            <p style="text-align: center; font-size: 0.9em; color: #999;">
                Current: <span id="current-api-url" style="color: #0a3a2a; font-weight: bold; direction: ltr; display: inline-block;"></span>
            </p>
        </div>

        <div class="card">
            <div id="position-indicator" class="hidden">
                <div class="position-indicator">
                    <h2 id="surah-name">---</h2>
                    <div class="position-details">
                        <div class="position-detail">
                            <label>Ø§Ù„Ø¢ÙŠØ©</label>
                            <value id="ayah-number">-</value>
                        </div>
                        <div class="position-detail">
                            <label>Ø§Ù„ØµÙØ­Ø©</label>
                            <value id="page-number">-</value>
                        </div>
                        <div class="position-detail">
                            <label>Ø§Ù„Ø¬Ø²Ø¡</label>
                            <value id="juz-number">-</value>
                        </div>
                        <div class="position-detail">
                            <label>Ø§Ù„Ø«Ù‚Ø©</label>
                            <value id="confidence">-</value>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status idle" id="status">
                <span id="status-text">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ø¬ÙŠÙ„ - Ø§Ø¶ØºØ· "Ø§Ø³ØªÙ…Ø¹" ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ„Ø§ÙˆØ© Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†</span>
            </div>

            <div class="controls">
                <button id="listen-btn" onclick="toggleListening()">
                    ğŸ¤ Ø§Ø³ØªÙ…Ø¹
                </button>
            </div>

            <div id="error-container"></div>

            <div class="transcript-box">
                <h4>ğŸ“ Ù…Ø§ ØªÙ… Ø³Ù…Ø§Ø¹Ù‡:</h4>
                <div class="transcript-text" id="transcript">
                    <em style="color: #999;">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³Ù…ÙˆØ¹...</em>
                </div>
            </div>
        </div>

        <div class="card hidden" id="verse-container">
            <div class="verse-display">
                <h3 id="verse-header">Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:</h3>
                <div class="arabic-text" id="verse-text"></div>
            </div>
        </div>

        <div class="card hidden" id="stats-container">
            <h2 style="color: #0a3a2a; margin-bottom: 20px; text-align: center;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <label>Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ¹Ø©</label>
                    <value id="total-words">0</value>
                </div>
                <div class="stat-card">
                    <label>Ø§Ù„Ø³ÙˆØ± Ø§Ù„Ù…ÙƒØªØ´ÙØ©</label>
                    <value id="surahs-detected">0</value>
                </div>
                <div class="stat-card">
                    <label>Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</label>
                    <value id="session-duration">0:00</value>
                </div>
                <div class="stat-card">
                    <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø©</label>
                    <value id="avg-confidence">0%</value>
                </div>
            </div>

            <div class="session-info" id="session-summary"></div>
        </div>

        <!-- Analysis Report Container (Post-Processing) -->
        <div class="card hidden" id="analysis-report">
            <!-- Report will be populated by JavaScript -->
        </div>
    </div>

    <footer>
        <p>Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒ Ø¹Ù„Ù‰ ØªÙ„Ø§ÙˆØªÙƒ Ù„Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</p>
        <p style="font-size: 0.9em; margin-top: 10px;">Powered by Hafiz Backend API</p>
    </footer>

    <script>
        // Configuration - can be set via URL parameter or localStorage
        let API_URL = localStorage.getItem('apiUrl') || 'http://localhost:5001';
        const DETECTION_INTERVAL = 3000; // Detect position every 3 seconds
        const MIN_WORDS_FOR_DETECTION = 5; // Minimum words before trying detection

        // Check for URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('apiUrl')) {
            API_URL = urlParams.get('apiUrl');
            localStorage.setItem('apiUrl', API_URL);
        }

        // State
        let recognition = null;
        let isListening = false;
        let sessionStart = null;
        let transcript = '';
        let transcriptWords = [];
        let detectedSurahs = new Set();
        let lastPosition = null;
        let detectionTimer = null;
        let confidenceScores = [];

        // Initialize Speech Recognition
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showError('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome Ø£Ùˆ Edge.');
                return false;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();

            recognition.lang = 'ar-SA';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                console.log('ğŸ¤ Speech recognition started');
                console.log('   Language:', recognition.lang);
                console.log('   Continuous:', recognition.continuous);
                console.log('   Interim results:', recognition.interimResults);
                updateStatus('listening', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹... ØªÙ„Ù Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¨ØµÙˆØª ÙˆØ§Ø¶Ø­');
            };

            recognition.onresult = (event) => {
                console.log('Speech recognition result:', event.results.length, 'results');
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcriptPiece = event.results[i][0].transcript;
                    console.log(`  Result ${i}: "${transcriptPiece}" (final: ${event.results[i].isFinal})`);

                    if (event.results[i].isFinal) {
                        finalTranscript += transcriptPiece + ' ';
                    } else {
                        interimTranscript += transcriptPiece + ' ';
                    }
                }

                if (finalTranscript) {
                    transcript += finalTranscript;
                    transcriptWords = transcript.trim().split(/\s+/).filter(w => w.length > 0);
                    console.log('Updated transcript:', transcript);
                    console.log('Word count:', transcriptWords.length);
                    updateTranscriptDisplay();
                    updateStats();
                }

                // Show interim results
                if (interimTranscript) {
                    document.getElementById('transcript').innerHTML =
                        transcript + '<span style="color: #999;">' + interimTranscript + '</span>';
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    updateStatus('listening', 'Ù„Ù… ÙŠØªÙ… Ø³Ù…Ø§Ø¹ Ø£ÙŠ ØµÙˆØª... Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ„Ø§ÙˆØ©');
                } else if (event.error === 'network') {
                    showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                } else {
                    showError(`Ø®Ø·Ø£: ${event.error}`);
                }
            };

            recognition.onend = () => {
                console.log('ğŸ”š Speech recognition ended');
                console.log('   isListening:', isListening);
                console.log('   Transcript so far:', transcript);
                console.log('   Word count:', transcriptWords.length);

                if (isListening) {
                    // Restart if we're still supposed to be listening
                    console.log('   â†’ Restarting recognition...');
                    recognition.start();
                }
            };

            return true;
        }

        // Toggle Listening
        function toggleListening() {
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    return;
                }
            }

            const btn = document.getElementById('listen-btn');

            if (!isListening) {
                // Start listening
                isListening = true;
                sessionStart = new Date();
                transcript = '';
                transcriptWords = [];
                detectedSurahs = new Set();
                confidenceScores = [];

                btn.textContent = 'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù';
                btn.classList.add('listening');

                recognition.start();

                // No periodic detection - we'll analyze when user stops
                document.getElementById('stats-container').classList.remove('hidden');
                updateStats();
            } else {
                // Stop listening
                stopListening();
            }
        }

        function stopListening() {
            console.log('ğŸ›‘ Stopping listening...');
            console.log('   Current transcript:', transcript);
            console.log('   Word count:', transcriptWords.length);

            isListening = false;
            const btn = document.getElementById('listen-btn');

            btn.textContent = 'ğŸ¤ Ø§Ø³ØªÙ…Ø¹';
            btn.classList.remove('listening');

            if (recognition) {
                recognition.stop();
            }

            // Wait a moment for final recognition results, then analyze
            setTimeout(() => {
                console.log('ğŸ“Š Final transcript before analysis:', transcript);
                console.log('   Final word count:', transcriptWords.length);
                analyzeFullRecitation();
            }, 500);
        }

        // Analyze Full Recitation (Post-Processing)
        async function analyzeFullRecitation() {
            console.log('ğŸ” analyzeFullRecitation called');
            console.log('   Transcript:', transcript);
            console.log('   Words count:', transcriptWords.length);
            console.log('   API URL:', API_URL);

            if (transcriptWords.length < MIN_WORDS_FOR_DETECTION) {
                const msg = `Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ Ù„Ù„ØªØ­Ù„ÙŠÙ„ (${transcriptWords.length} ÙƒÙ„Ù…Ø©ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ${MIN_WORDS_FOR_DETECTION})`;
                console.warn('âš ï¸', msg);
                updateStatus('error', msg);
                showSessionSummary();
                return;
            }

            updateStatus('detecting', 'ğŸ” Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ ØªÙ„Ø§ÙˆØªÙƒ...');

            const duration = sessionStart ? new Date() - sessionStart : 0;

            console.log('ğŸ“¤ Sending analysis request...');
            console.log('   URL:', `${API_URL}/api/recitation/analyze-full`);
            console.log('   Duration:', duration);

            try {
                const response = await fetch(`${API_URL}/api/recitation/analyze-full`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transcript: transcript,
                        duration: duration,
                        wordCount: transcriptWords.length
                    })
                });

                console.log('ğŸ“¥ Response received:', response.status);
                const report = await response.json();
                console.log('ğŸ“Š Report:', report);

                if (report.success) {
                    displayAnalysisReport(report);
                } else {
                    // Handle analysis failures
                    if (report.error === 'surah_not_identified') {
                        updateStatus('error', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙˆØ±Ø© - Ø­Ø§ÙˆÙ„ Ø§Ù„ØªÙ„Ø§ÙˆØ© Ø¨Ø´ÙƒÙ„ Ø£ÙˆØ¶Ø­');
                    } else if (report.error === 'low_confidence') {
                        updateStatus('warning', 'Ø«Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø© ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù - Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø©');
                        if (report.topCandidates && report.topCandidates.length > 0) {
                            const candidates = report.topCandidates
                                .map(c => `${c.surahName} (${(c.confidence * 100).toFixed(0)}%)`)
                                .join('ØŒ ');
                            showError(`Ø§Ù„Ø³ÙˆØ± Ø§Ù„Ù…Ø±Ø´Ø­Ø©: ${candidates}`);
                        }
                    } else {
                        updateStatus('error', `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${report.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`);
                    }
                    showSessionSummary();
                }
            } catch (error) {
                console.error('âŒ Error analyzing recitation:', error);
                console.error('   Error type:', error.name);
                console.error('   Error message:', error.message);

                let errorMsg = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ù„ØªØ­Ù„ÙŠÙ„';
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = `ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… - ØªØ£ÙƒØ¯ Ù…Ù† ØªÙƒÙˆÙŠÙ† Ø±Ø§Ø¨Ø· API: ${API_URL}`;
                }

                updateStatus('error', errorMsg);
                showError(`Ø®Ø·Ø£: ${error.message}`);
                showSessionSummary();
            }
        }

        // Display Comprehensive Analysis Report
        function displayAnalysisReport(report) {
            const summary = report.summary;

            // Update status with success
            updateStatus('success', `âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ - ${summary.primarySurah.name}`);

            // Hide verse container if it exists
            const verseContainer = document.getElementById('verse-container');
            if (verseContainer) {
                verseContainer.classList.add('hidden');
            }

            // Show analysis report
            const reportContainer = document.getElementById('analysis-report');
            reportContainer.classList.remove('hidden');

            // Build report HTML
            let html = '';

            // Summary Section
            html += '<div class="report-section summary-section">';
            html += `<h2 style="color: #d4af37; margin-bottom: 20px;">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ„Ø§ÙˆØ©</h2>`;
            html += '<div class="summary-grid">';
            html += `<div class="summary-item">
                        <div class="summary-label">Ø§Ù„Ø³ÙˆØ±Ø©</div>
                        <div class="summary-value">${summary.primarySurah.name}</div>
                        <div class="summary-sublabel">${summary.primarySurah.nameEn}</div>
                    </div>`;

            // Show verse range if available
            if (summary.verseRange && summary.verseRange.start !== summary.verseRange.end) {
                html += `<div class="summary-item">
                            <div class="summary-label">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¢ÙŠØ§Øª</div>
                            <div class="summary-value">${summary.verseRange.start}-${summary.verseRange.end}</div>
                            <div class="summary-sublabel">Ù…Ù† ${summary.verseRange.count} Ø¢ÙŠØ©</div>
                        </div>`;
            }

            html += `<div class="summary-item">
                        <div class="summary-label">Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
                        <div class="summary-value ${summary.overallAccuracy >= 0.90 ? 'excellent' : summary.overallAccuracy >= 0.70 ? 'good' : 'needs-work'}">
                            ${(summary.overallAccuracy * 100).toFixed(0)}%
                        </div>
                    </div>`;
            html += `<div class="summary-item">
                        <div class="summary-label">Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù…ÙØªÙ„Ø§Ø©</div>
                        <div class="summary-value">${summary.versesRecited} / ${summary.versesInRange}</div>
                    </div>`;
            html += `<div class="summary-item">
                        <div class="summary-label">Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù…ØªØ®Ø·Ø§Ø©</div>
                        <div class="summary-value ${summary.versesSkipped.length === 0 ? 'excellent' : 'needs-work'}">
                            ${summary.versesSkipped.length}
                        </div>
                    </div>`;
            html += '</div>';
            html += '</div>';

            // Verses Section
            if (report.verses && report.verses.length > 0) {
                html += '<div class="report-section verses-section">';
                html += '<h3 style="color: #0a3a2a; margin-bottom: 15px;">ğŸ“– ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¢ÙŠØ§Øª</h3>';

                for (const verse of report.verses) {
                    const statusEmoji = verse.status === 'perfect' ? 'âœ…' :
                                       verse.status === 'good' ? 'ğŸ‘' :
                                       verse.status === 'partial' ? 'âš ï¸' : 'âŒ';
                    const statusText = verse.status === 'perfect' ? 'Ù…Ù…ØªØ§Ø²' :
                                      verse.status === 'good' ? 'Ø¬ÙŠØ¯' :
                                      verse.status === 'partial' ? 'Ø¬Ø²Ø¦ÙŠ' : 'Ù…ØªØ®Ø·Ø§Ø©';
                    const statusClass = verse.status === 'perfect' ? 'verse-perfect' :
                                       verse.status === 'good' ? 'verse-good' :
                                       verse.status === 'partial' ? 'verse-partial' : 'verse-skipped';

                    html += `<div class="verse-item ${statusClass}">`;
                    html += `<div class="verse-header">
                                <span class="verse-number">Ø§Ù„Ø¢ÙŠØ© ${verse.ayah}</span>
                                <span class="verse-status">${statusEmoji} ${statusText} (${(verse.accuracy * 100).toFixed(0)}%)</span>
                            </div>`;
                    html += `<div class="verse-text">${verse.text}</div>`;
                    html += `<div class="verse-details">
                                Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ${verse.wordsMatched} / ${verse.wordCount}
                                ${verse.wordsMissing > 0 ? `<span style="color: #e74c3c; margin-right: 10px;">Ù†Ø§Ù‚Øµ: ${verse.wordsMissing}</span>` : ''}
                            </div>`;
                    html += '</div>';
                }

                html += '</div>';
            }

            // Mistakes Section
            if (report.mistakes && report.mistakes.length > 0) {
                html += '<div class="report-section mistakes-section">';
                html += '<h3 style="color: #e74c3c; margin-bottom: 15px;">âš ï¸ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>';

                for (const mistake of report.mistakes) {
                    html += '<div class="mistake-item">';
                    if (mistake.type === 'skipped_verse') {
                        html += `<div class="mistake-title">Ø¢ÙŠØ© Ù…ØªØ®Ø·Ø§Ø©: ${mistake.ayah}</div>`;
                        html += `<div class="mistake-suggestion">${mistake.suggestion}</div>`;
                    } else if (mistake.type === 'missing_words') {
                        html += `<div class="mistake-title">ÙƒÙ„Ù…Ø§Øª Ù†Ø§Ù‚ØµØ© ÙÙŠ Ø§Ù„Ø¢ÙŠØ© ${mistake.ayah}</div>`;
                        html += `<div class="mistake-words">${mistake.words.join('ØŒ ')}</div>`;
                        html += `<div class="mistake-suggestion">${mistake.suggestion}</div>`;
                    }
                    html += '</div>';
                }

                html += '</div>';
            }

            // Recommendations Section
            if (report.recommendations && report.recommendations.length > 0) {
                html += '<div class="report-section recommendations-section">';
                html += '<h3 style="color: #27ae60; margin-bottom: 15px;">ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª</h3>';
                html += '<ul class="recommendations-list">';

                for (const rec of report.recommendations) {
                    html += `<li>${rec}</li>`;
                }

                html += '</ul>';
                html += '</div>';
            }

            // Encouragement
            html += '<div class="encouragement">';
            if (summary.overallAccuracy >= 0.95) {
                html += 'ğŸŒŸ Ù…Ø§Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡! ØªÙ„Ø§ÙˆØ© Ù…Ù…ØªØ§Ø²Ø© Ø¬Ø¯Ø§Ù‹ - Ø¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙƒ';
            } else if (summary.overallAccuracy >= 0.80) {
                html += 'ğŸ‘ Ø£Ø­Ø³Ù†Øª! ØªÙ„Ø§ÙˆØ© Ø¬ÙŠØ¯Ø© Ø¬Ø¯Ø§Ù‹ - ÙˆØ§ØµÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨';
            } else if (summary.overallAccuracy >= 0.60) {
                html += 'ğŸ’ª Ø¬ÙŠØ¯! Ù‡Ù†Ø§Ùƒ Ù…Ø¬Ø§Ù„ Ù„Ù„ØªØ­Ø³ÙŠÙ† - Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
            } else {
                html += 'ğŸ“š Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø³ÙˆØ±Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ - Ø§Ù„Ù†Ø¬Ø§Ø­ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø«Ø§Ø¨Ø±Ø©';
            }
            html += '</div>';

            reportContainer.innerHTML = html;
        }

        // Detect Position from Backend (Legacy - kept for compatibility)
        async function detectPosition() {
            if (transcriptWords.length < MIN_WORDS_FOR_DETECTION) {
                return;
            }

            updateStatus('detecting', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¶Ø¹Ùƒ ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†...');

            try {
                const response = await fetch(`${API_URL}/api/recitation/detect-position`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transcript: transcript,
                        lastKnownPosition: lastPosition
                    })
                });

                const data = await response.json();

                if (data.success && data.detected) {
                    lastPosition = data.position;
                    confidenceScores.push(data.confidence);
                    detectedSurahs.add(data.position.surah);

                    updatePositionDisplay(data.position, data.confidence);
                    await loadVerses(data.position);

                    updateStatus('success',
                        `âœ… ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: ${data.position.surahName} - Ø§Ù„Ø¢ÙŠØ© ${data.position.ayahStart}`
                    );
                } else {
                    updateStatus('listening', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹... Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¨Ø¹Ø¯ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ„Ø§ÙˆØ©');
                }
            } catch (error) {
                console.error('Position detection error:', error);
                showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 5001');
            }
        }

        // Update Position Display
        function updatePositionDisplay(position, confidence) {
            document.getElementById('position-indicator').classList.remove('hidden');

            document.getElementById('surah-name').textContent =
                `${position.surahName} (${position.surahNameEn})`;
            document.getElementById('ayah-number').textContent = position.ayahStart;
            document.getElementById('page-number').textContent = position.page;
            document.getElementById('juz-number').textContent = position.juz;
            document.getElementById('confidence').textContent =
                `${(confidence * 100).toFixed(0)}%`;
        }

        // Load Verses from Backend
        async function loadVerses(position) {
            try {
                const response = await fetch(`${API_URL}/api/recitation/surah/${position.surah}`);
                const data = await response.json();

                if (data.success && data.verses) {
                    const versesToShow = data.verses.slice(
                        position.ayahStart - 1,
                        Math.min(position.ayahStart + 2, data.verses.length)
                    );

                    const verseText = versesToShow.map(v => v.text).join(' Û ');

                    document.getElementById('verse-text').textContent = verseText;
                    document.getElementById('verse-container').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading verses:', error);
            }
        }

        // Update Transcript Display
        function updateTranscriptDisplay() {
            const transcriptEl = document.getElementById('transcript');
            if (transcript.trim()) {
                transcriptEl.textContent = transcript;
            }
        }

        // Update Statistics
        function updateStats() {
            document.getElementById('total-words').textContent = transcriptWords.length;
            document.getElementById('surahs-detected').textContent = detectedSurahs.size;

            if (sessionStart) {
                const duration = Math.floor((new Date() - sessionStart) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                document.getElementById('session-duration').textContent =
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            if (confidenceScores.length > 0) {
                const avgConfidence = confidenceScores.reduce((a, b) => a + b, 0) / confidenceScores.length;
                document.getElementById('avg-confidence').textContent =
                    `${(avgConfidence * 100).toFixed(0)}%`;
            }
        }

        // Show Session Summary
        function showSessionSummary() {
            const summary = document.getElementById('session-summary');
            const duration = sessionStart ? Math.floor((new Date() - sessionStart) / 1000) : 0;
            const minutes = Math.floor(duration / 60);

            let summaryHTML = '<h3 style="margin-bottom: 10px;">Ù…Ù„Ø®Øµ Ø§Ù„Ø¬Ù„Ø³Ø©:</h3>';
            summaryHTML += `<p>ğŸ“– Ø§Ù„Ø³ÙˆØ± Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${detectedSurahs.size}</p>`;
            summaryHTML += `<p>ğŸ“ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ¹Ø©: ${transcriptWords.length}</p>`;
            summaryHTML += `<p>â±ï¸ Ø§Ù„Ù…Ø¯Ø©: ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©</p>`;

            if (lastPosition) {
                summaryHTML += `<p>ğŸ“ Ø¢Ø®Ø± Ù…ÙˆØ¶Ø¹: ${lastPosition.surahName} - Ø§Ù„Ø¢ÙŠØ© ${lastPosition.ayahStart}</p>`;
            }

            summary.innerHTML = summaryHTML;
        }

        // Update Status
        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = 'status ' + type;
            document.getElementById('status-text').textContent = message;
        }

        // Show Error
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        // Update API URL
        function updateApiUrl() {
            const input = document.getElementById('api-url-input');
            let newUrl = input.value.trim();

            // Remove trailing slash
            if (newUrl.endsWith('/')) {
                newUrl = newUrl.slice(0, -1);
            }

            API_URL = newUrl;
            localStorage.setItem('apiUrl', API_URL);

            document.getElementById('current-api-url').textContent = API_URL;

            showError('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø¯Ù…. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...');
            setTimeout(() => {
                checkBackendStatus();
            }, 500);
        }

        // Check Backend Status on Load
        async function checkBackendStatus() {
            try {
                const response = await fetch(`${API_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                });
                const data = await response.json();

                if (data.status === 'ok') {
                    console.log('âœ… Backend is ready');
                    console.log(`ğŸ“– ${data.quranData.verses} verses loaded`);
                    document.getElementById('config-card').style.display = 'none';
                    document.getElementById('current-api-url').textContent = API_URL;
                } else {
                    showError('Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ø¬Ø§Ù‡Ø². ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„Ù‡ Ø£ÙˆÙ„Ø§Ù‹.');
                    showConfigCard();
                }
            } catch (error) {
                console.error('Backend connection error:', error);
                showError('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø¯Ù†Ø§Ù‡.');
                showConfigCard();
            }
        }

        function showConfigCard() {
            const configCard = document.getElementById('config-card');
            const apiUrlInput = document.getElementById('api-url-input');

            configCard.style.display = 'block';
            apiUrlInput.value = API_URL;
            document.getElementById('current-api-url').textContent = API_URL;
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            checkBackendStatus();
        });

        // Update stats every second
        setInterval(() => {
            if (isListening) {
                updateStats();
            }
        }, 1000);
    </script>
</body>
</html>
